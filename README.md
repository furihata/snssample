# snssample

これは PHP スクリプトを AWS で動作させるためのサンプルです。
インフラ構築を Terraform、ビルドを GitHub + CircleCI で行い、Docker コンテナ化して AWS ECS + Fargate で動作させます。

## 各ファイル、ディレクトリの説明

- .circleci ... CircleCI でのビルド設定が格納されています。
- script ... DB 初期化用のスクリプトが入っています。
- server ... コンテナの中に入れるファイルです。コンテナの起動スクリプト、PHP設定ファイル、PHPスクリプト本体が入っています。
- terraform ... インフラ構築用の設定です。
- Dockerfile ... ECS で動かすコンテナ構築用の設定です。

## CircleCI について

- Orb を使えばコンテナイメージのビルドと ECR への登録まで一気に行えるようなのですが、実験も兼ねて自分で docker build しています。
- docker をインストールするため、実行環境をコンテナではなく VM にしています。

## DB 初期化スクリプトについて

- Terraform の設定を変更して RDS の Public アクセスを有効化できるようにしています。
- 作業環境の IP アドレスを指定してポート 3306 を通過可能とし、MySql クライアントを接続して初期化を行います。
- 初期化後は Public アクセスを無効化して外部からのポート 3306 への接続も閉じます。

## PHP スクリプトについて

- ECS の Task 設定を使い環境変数経由で RDS への接続情報を貰います。
- そのため PHP.ini の設定をデフォルトから変更して $_ENV 経由での環境変数取得を有効化しています。
- プログラム自体はごく簡単なものです。

## Terraform について

- 実行前に環境変数 `TF_VAR_db_password` に RDS へ接続するパスワードを設定しておく必要があります。
- AWS CloudShell での実行を前提としているため設定ファイル内に Credentials の記載がありません。
- 当初規模が小さかったので tf ファイルを分割していませんでしたが、思ったより長くなったので分割したほうがよかったかもしれません。今後のリファクタリングポイントと考えています。

## Dockerfile について

- Ubuntu Linux 20.04 LTS をベースとして、Apache と PHP を両方入れ、mod_php で動かしています。NGINX と PHP-FPM の組み合わせのほうが一般的かもしれませんが、Apache に慣れていたのでこちらにしました。

## このリポジトリについて

なにかありましたら Issue にてご連絡下さい。
こちらは個人的サンプルとして作成したもので、実運用に耐えられるか検証したものではありません。
他社の権利を侵害しないように注意深く作成致しましたが、それを保証するものではありません。
